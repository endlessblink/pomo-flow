<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Import Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
        }
        .log-info { background: #e3f2fd; color: #1976d2; }
        .log-success { background: #e8f5e8; color: #2e7d32; }
        .log-error { background: #ffebee; color: #c62828; }
        .log-warning { background: #fff3e0; color: #f57c00; }
        button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #1565c0; }
        #status {
            font-weight: bold;
            margin: 10px 0;
        }
        .loading { color: #f57c00; }
        .success { color: #2e7d32; }
        .error { color: #c62828; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üçÖ Pomo-Flow Task Import Test</h1>

        <div class="test-section">
            <h2>Test Status</h2>
            <div id="status" class="loading">Initializing test...</div>
            <button onclick="runTest()">Run Test Again</button>
            <button onclick="clearIndexedDB()">Clear IndexedDB & Test Fresh</button>
            <button onclick="checkTasksDirectly()">Check Tasks Directly</button>
        </div>

        <div class="test-section">
            <h2>Console Log Output</h2>
            <div id="console-output"></div>
        </div>

        <div class="test-section">
            <h2>Application Status</h2>
            <div id="app-status">
                <p><strong>Tasks JSON URL:</strong> <a href="http://localhost:5550/tasks.json" target="_blank">http://localhost:5550/tasks.json</a></p>
                <p><strong>Application URL:</strong> <a href="http://localhost:5550" target="_blank">http://localhost:5550</a></p>
                <div id="indexeddb-status"></div>
                <div id="tasks-count"></div>
            </div>
        </div>
    </div>

    <script>
        let logMessages = [];

        // Override console methods to capture logs
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn,
            info: console.info
        };

        function addLogEntry(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = { timestamp, message, type };
            logMessages.push(logEntry);
            displayLogEntry(logEntry);
        }

        function displayLogEntry(entry) {
            const output = document.getElementById('console-output');
            const div = document.createElement('div');
            div.className = `log-entry log-${entry.type}`;
            div.innerHTML = `<strong>[${entry.timestamp}]</strong> ${entry.message}`;
            output.appendChild(div);
            output.scrollTop = output.scrollHeight;
        }

        function captureConsoleLogs() {
            console.log = function(...args) {
                addLogEntry(args.join(' '), 'info');
                originalConsole.log.apply(console, args);
            };

            console.error = function(...args) {
                addLogEntry(args.join(' '), 'error');
                originalConsole.error.apply(console, args);
            };

            console.warn = function(...args) {
                addLogEntry(args.join(' '), 'warning');
                originalConsole.warn.apply(console, args);
            };

            console.info = function(...args) {
                addLogEntry(args.join(' '), 'info');
                originalConsole.info.apply(console, args);
            };
        }

        function updateStatus(message, type = 'loading') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = type;
        }

        async function checkTasksDirectly() {
            try {
                const response = await fetch('http://localhost:5550/tasks.json');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const tasks = await response.json();
                addLogEntry(`‚úÖ Direct fetch successful: Found ${tasks.length} tasks in JSON file`, 'success');

                // Display first few tasks
                tasks.slice(0, 3).forEach(task => {
                    addLogEntry(`üìã Task: ${task.title} (${task.status})`, 'info');
                });

                updateStatus(`‚úÖ Found ${tasks.length} tasks in JSON file`, 'success');
            } catch (error) {
                addLogEntry(`‚ùå Direct fetch failed: ${error.message}`, 'error');
                updateStatus(`‚ùå Failed to fetch tasks.json: ${error.message}`, 'error');
            }
        }

        async function clearIndexedDB() {
            try {
                addLogEntry('üóëÔ∏è Attempting to clear IndexedDB...', 'info');
                const databases = await indexedDB.databases();

                for (const db of databases) {
                    if (db.name === 'pomo-flow') {
                        await indexedDB.deleteDatabase(db.name);
                        addLogEntry(`‚úÖ Deleted database: ${db.name}`, 'success');
                    }
                }

                addLogEntry('üóëÔ∏è IndexedDB cleared. Reloading page in 2 seconds...', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } catch (error) {
                addLogEntry(`‚ùå Failed to clear IndexedDB: ${error.message}`, 'error');
            }
        }

        async function checkIndexedDBStatus() {
            try {
                const request = indexedDB.open('pomo-flow', 3);

                request.onerror = () => {
                    addLogEntry('‚ùå IndexedDB not accessible', 'error');
                    document.getElementById('indexeddb-status').innerHTML = '<p><strong>IndexedDB:</strong> ‚ùå Not accessible</p>';
                };

                request.onsuccess = (event) => {
                    const db = event.target.result;
                    addLogEntry('‚úÖ IndexedDB is accessible', 'success');
                    document.getElementById('indexeddb-status').innerHTML = '<p><strong>IndexedDB:</strong> ‚úÖ Accessible</p>';

                    if (db.objectStoreNames.contains('pomo_flow_data')) {
                        const transaction = db.transaction(['pomo_flow_data'], 'readonly');
                        const store = transaction.objectStore('pomo_flow_data');
                        const getRequest = store.get('tasks');

                        getRequest.onsuccess = (event) => {
                            const tasks = event.target.result;
                            if (tasks) {
                                try {
                                    const parsedTasks = JSON.parse(tasks);
                                    addLogEntry(`üìÇ Found ${parsedTasks.length} tasks in IndexedDB`, 'success');
                                    document.getElementById('tasks-count').innerHTML = `<p><strong>Tasks in IndexedDB:</strong> ${parsedTasks.length}</p>`;
                                } catch (e) {
                                    addLogEntry('‚ùå Failed to parse tasks from IndexedDB', 'error');
                                }
                            } else {
                                addLogEntry('üìÇ No tasks found in IndexedDB', 'warning');
                                document.getElementById('tasks-count').innerHTML = '<p><strong>Tasks in IndexedDB:</strong> 0 (empty)</p>';
                            }
                        };

                        getRequest.onerror = () => {
                            addLogEntry('‚ùå Failed to read tasks from IndexedDB', 'error');
                        };
                    } else {
                        addLogEntry('‚ö†Ô∏è pomo_flow_data store not found', 'warning');
                    }

                    db.close();
                };

                request.onupgradeneeded = () => {
                    addLogEntry('‚ö†Ô∏è IndexedDB needs upgrade', 'warning');
                };
            } catch (error) {
                addLogEntry(`‚ùå IndexedDB check failed: ${error.message}`, 'error');
            }
        }

        async function testTaskImport() {
            captureConsoleLogs();
            addLogEntry('üß™ Starting task import test...', 'info');

            // Check if application is running
            try {
                const response = await fetch('http://localhost:5550');
                if (response.ok) {
                    addLogEntry('‚úÖ Pomo-Flow application is running', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                addLogEntry(`‚ùå Cannot reach Pomo-Flow application: ${error.message}`, 'error');
                updateStatus('‚ùå Application not reachable', 'error');
                return;
            }

            // Check tasks.json file
            await checkTasksDirectly();

            // Check IndexedDB status
            await checkIndexedDBStatus();

            // Try to access the application in an iframe to see console logs
            try {
                addLogEntry('üîç Loading application in test frame...', 'info');
                const iframe = document.createElement('iframe');
                iframe.style.width = '100%';
                iframe.style.height = '400px';
                iframe.style.border = '1px solid #ddd';
                iframe.style.borderRadius = '5px';
                iframe.src = 'http://localhost:5550';

                iframe.onload = () => {
                    addLogEntry('‚úÖ Application loaded in test frame', 'success');

                    // Try to access console logs from iframe (limited by cross-origin policies)
                    try {
                        iframe.contentWindow.console.log = function(...args) {
                            addLogEntry(`[APP] ${args.join(' ')}`, 'info');
                        };
                    } catch (e) {
                        addLogEntry('‚ö†Ô∏è Cannot access iframe console due to cross-origin policy', 'warning');
                    }
                };

                iframe.onerror = () => {
                    addLogEntry('‚ùå Failed to load application in iframe', 'error');
                };

                document.body.appendChild(iframe);

                // Wait a bit and then check IndexedDB again
                setTimeout(async () => {
                    await checkIndexedDBStatus();
                    updateStatus('‚úÖ Test completed - Check logs above for import status', 'success');
                }, 3000);

            } catch (error) {
                addLogEntry(`‚ùå Failed to load application: ${error.message}`, 'error');
            }
        }

        function runTest() {
            // Clear previous logs
            logMessages = [];
            document.getElementById('console-output').innerHTML = '';
            updateStatus('üîÑ Running test...', 'loading');

            // Run the test
            testTaskImport();
        }

        // Auto-run test when page loads
        window.addEventListener('load', () => {
            setTimeout(runTest, 1000);
        });
    </script>
</body>
</html>