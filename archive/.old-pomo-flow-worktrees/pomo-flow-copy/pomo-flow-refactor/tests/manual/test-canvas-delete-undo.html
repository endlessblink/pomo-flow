// Test script to verify canvas delete undo fix
console.log('ğŸ§ª Testing canvas delete undo fix...');

// Simple test to check if the async fix works
async function testCanvasDeleteUndo() {
  try {
    // Navigate to canvas
    console.log('ğŸŒ Navigating to canvas...');
    window.location.href = 'http://localhost:5550/#/canvas';

    // Wait for page to load
    await new Promise(resolve => setTimeout(resolve, 2000));

    // Create some test elements on canvas
    console.log('ğŸ“ Creating test canvas elements...');

    // Simulate canvas clicks to create nodes
    const canvas = document.querySelector('.vue-flow');
    if (canvas) {
      // Click to create a few nodes
      const clickPositions = [
        { x: 200, y: 200 },
        { x: 400, y: 300 },
        { x: 600, y: 200 }
      ];

      for (const pos of clickPositions) {
        canvas.dispatchEvent(new MouseEvent('click', {
          clientX: pos.x,
          clientY: pos.y,
          bubbles: true
        }));
        await new Promise(resolve => setTimeout(resolve, 500));
      }

      console.log('âœ… Created 3 test nodes on canvas');

      // Select first node
      const nodes = document.querySelectorAll('.vue-flow__node');
      if (nodes.length > 0) {
        nodes[0].click();
        console.log('ğŸ¯ Selected first node');

        // Test Delete key
        console.log('âŒ¨ï¸ Testing Delete key...');

        // Listen for console logs from the app
        const originalLog = console.log;
        const logs = [];
        console.log = (...args) => {
          logs.push(args.join(' '));
          originalLog(...args);
        };

        // Press Delete key
        document.dispatchEvent(new KeyboardEvent('keydown', {
          key: 'Delete',
          bubbles: true
        }));

        await new Promise(resolve => setTimeout(resolve, 1000));

        // Check if our fix worked
        const hasUndoLog = logs.some(log => log.includes('moving to inbox with undo support'));
        const hasProcessingLog = logs.some(log => log.includes('Processing deletion for'));

        console.log('ğŸ” Console logs captured:', logs);
        console.log('âœ… Has undo support log:', hasUndoLog);
        console.log('âœ… Has processing log:', hasProcessingLog);

        // Test Cmd+Z
        console.log('âŒ¨ï¸ Testing Cmd+Z...');
        document.dispatchEvent(new KeyboardEvent('keydown', {
          key: 'z',
          metaKey: true,
          bubbles: true
        }));

        await new Promise(resolve => setTimeout(resolve, 1000));

        // Restore original console.log
        console.log = originalLog;

        console.log('ğŸ‰ Canvas delete undo test completed!');
        console.log('ğŸ“ Check if the node was restored after Cmd+Z');

        return {
          success: true,
          hasUndoLog,
          hasProcessingLog,
          nodeCountBefore: nodes.length,
          nodeCountAfter: document.querySelectorAll('.vue-flow__node').length
        };
      } else {
        console.log('âŒ No nodes found on canvas');
        return { success: false, error: 'No nodes found' };
      }
    } else {
      console.log('âŒ Canvas element not found');
      return { success: false, error: 'Canvas not found' };
    }
  } catch (error) {
    console.error('âŒ Test failed:', error);
    return { success: false, error: error.message };
  }
}

// Auto-run test if in browser
if (typeof window !== 'undefined') {
  testCanvasDeleteUndo().then(result => {
    console.log('ğŸ“Š Test result:', result);
  });
}