<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Undo/Redo Debug Test</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: #f8fafc;
        }
        .debug-section {
            background: white;
            padding: 1.5rem;
            margin: 1rem 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            margin: 0.5rem;
            font-size: 1rem;
        }
        .test-button:hover {
            background: #2563eb;
        }
        .status {
            padding: 0.5rem 1rem;
            margin: 0.5rem 0;
            border-radius: 4px;
            font-weight: 500;
        }
        .success { background: #dcfce7; color: #166534; }
        .error { background: #fef2f2; color: #dc2626; }
        .info { background: #eff6ff; color: #1d4ed8; }
        .warning { background: #fef3c7; color: #92400e; }
        .debug-output {
            background: #1f2937;
            color: #f3f4f6;
            padding: 1rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin: 1rem 0;
        }
        .keyboard-test {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1rem 0;
        }
        .key-indicator {
            padding: 0.5rem 1rem;
            background: #e5e7eb;
            border-radius: 4px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .key-indicator.active {
            background: #10b981;
            color: white;
        }
    </style>
</head>
<body>
    <h1>üîç Undo/Redo System Debug Test</h1>

    <div class="debug-section">
        <h2>üìã System Status Check</h2>
        <div id="system-status"></div>
        <button class="test-button" onclick="checkSystemStatus()">Check System Status</button>
    </div>

    <div class="debug-section">
        <h2>‚å®Ô∏è Keyboard Shortcut Test</h2>
        <div class="keyboard-test">
            <span>Press Ctrl+Z, Ctrl+Shift+Z, or Ctrl+Y:</span>
            <div class="key-indicator" id="ctrl-indicator">Ctrl</div>
            <div class="key-indicator" id="z-indicator">Z</div>
            <div class="key-indicator" id="shift-indicator">Shift</div>
            <div class="key-indicator" id="y-indicator">Y</div>
        </div>
        <div id="keyboard-status"></div>
        <div id="keyboard-output" class="debug-output"></div>
    </div>

    <div class="debug-section">
        <h2>üß™ Store Integration Test</h2>
        <button class="test-button" onclick="testUndoRedoStore()">Test Undo/Redo Store</button>
        <button class="test-button" onclick="testTaskOperations()">Test Task Operations</button>
        <button class="test-button" onclick="testKeyboardShortcuts()">Test Keyboard Shortcuts</button>
        <div id="store-status"></div>
        <div id="store-output" class="debug-output"></div>
    </div>

    <div class="debug-section">
        <h2>üîß Manual Test Steps</h2>
        <ol>
            <li>Open the main app at <a href="http://localhost:5173" target="_blank">http://localhost:5173</a></li>
            <li>Create a new task in any view</li>
            <li>Press Ctrl+Z - should undo the task creation</li>
            <li>Press Ctrl+Shift+Z - should redo the task creation</li>
            <li>Check browser console (F12) for any errors</li>
        </ol>
        <div id="manual-test-status"></div>
    </div>

    <script type="module">
        let debugOutput = [];
        let keyboardEvents = [];

        // Debug logging function
        function debug(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            debugOutput.push(entry);
            updateDebugOutput();
            console.log(entry);
        }

        function updateDebugOutput() {
            const outputElements = document.querySelectorAll('.debug-output');
            outputElements.forEach(el => {
                el.textContent = debugOutput.slice(-10).join('\n'); // Show last 10 messages
                el.scrollTop = el.scrollHeight;
            });
        }

        // Keyboard event tracking
        document.addEventListener('keydown', (event) => {
            const key = event.key.toLowerCase();
            const ctrl = event.ctrlKey || event.metaKey;
            const shift = event.shiftKey;
            const alt = event.altKey;

            // Update key indicators
            document.getElementById('ctrl-indicator').classList.toggle('active', ctrl);
            document.getElementById('shift-indicator').classList.toggle('active', shift);
            document.getElementById('z-indicator').classList.toggle('active', key === 'z');
            document.getElementById('y-indicator').classList.toggle('active', key === 'y');

            const keyInfo = {
                key: event.key,
                ctrl,
                shift,
                alt,
                code: event.code,
                which: event.which
            };

            keyboardEvents.push(keyInfo);

            // Check for undo/redo combinations
            if (ctrl && key === 'z' && !shift) {
                debug('Ctrl+Z detected - Undo', 'info');
                checkUndoRedoFunction('undo');
            } else if (ctrl && key === 'z' && shift) {
                debug('Ctrl+Shift+Z detected - Redo', 'info');
                checkUndoRedoFunction('redo');
            } else if (ctrl && key === 'y') {
                debug('Ctrl+Y detected - Redo', 'info');
                checkUndoRedoFunction('redo');
            }

            document.getElementById('keyboard-output').textContent =
                'Last keyboard events:\n' + keyboardEvents.slice(-5).map(e =>
                    `Key: ${e.key}, Ctrl: ${e.ctrl}, Shift: ${e.shift}, Alt: ${e.alt}`
                ).join('\n');
        });

        document.addEventListener('keyup', (event) => {
            // Reset key indicators
            setTimeout(() => {
                document.getElementById('ctrl-indicator').classList.remove('active');
                document.getElementById('shift-indicator').classList.remove('active');
                document.getElementById('z-indicator').classList.remove('active');
                document.getElementById('y-indicator').classList.remove('active');
            }, 100);
        });

        // Check if undo/redo functions are available globally
        function checkUndoRedoFunction(action) {
            try {
                // Try to access the undo/redo system through various means
                const checks = [
                    'window.undoRedo',
                    'window.__VUE_DEVTOOLS_GLOBAL_HOOK__',
                    'document.querySelector(\'[data-undo-redo]\')',
                    'localStorage.getItem(\'undoRedo\')'
                ];

                checks.forEach(check => {
                    try {
                        const result = eval(check);
                        debug(`Check ${check}: ${result}`, 'info');
                    } catch (e) {
                        debug(`Check ${check}: Error - ${e.message}`, 'error');
                    }
                });

                // Try to dispatch custom event to trigger undo/redo
                window.dispatchEvent(new CustomEvent('undo-redo-shortcut', {
                    detail: { action, timestamp: Date.now() }
                }));

                debug(`Attempted to trigger ${action} via custom event`, 'info');

            } catch (error) {
                debug(`Error checking ${action} function: ${error.message}`, 'error');
            }
        }

        // System status check
        window.checkSystemStatus = function() {
            const statusDiv = document.getElementById('system-status');
            const checks = [];

            // Check Vue app is running
            checks.push({
                name: 'Vue App Running',
                status: document.querySelector('#app') ? '‚úÖ Yes' : '‚ùå No'
            });

            // Check if stores are available
            checks.push({
                name: 'Module Scripts Available',
                status: document.querySelectorAll('script[type="module"]').length > 0 ? '‚úÖ Yes' : '‚ùå No'
            });

            // Check for console errors
            checks.push({
                name: 'Console Errors',
                status: 'üîç Check Browser Console (F12)'
            });

            // Check if running on correct port
            checks.push({
                name: 'Current URL',
                status: window.location.href
            });

            statusDiv.innerHTML = checks.map(check =>
                `<div class="status ${check.status.includes('‚úÖ') ? 'success' : check.status.includes('‚ùå') ? 'error' : 'info'}">
                    ${check.name}: ${check.status}
                </div>`
            ).join('');

            debug('System status check completed', 'info');
        };

        // Test undo/redo store
        window.testUndoRedoStore = function() {
            debug('Testing undo/redo store integration...', 'info');

            try {
                // Try to import and test the undo/redo store
                import('/src/stores/undoRedo.js').then(({ useUndoRedoStore }) => {
                    const store = useUndoRedoStore();

                    debug(`UndoRedo Store loaded: ${!!store}`, 'success');
                    debug(`Can undo: ${store.canUndo}`, 'info');
                    debug(`Can redo: ${store.canRedo}`, 'info');
                    debug(`Undo count: ${store.undoCount}`, 'info');
                    debug(`Redo count: ${store.redoCount}`, 'info');

                    // Test basic functionality
                    if (typeof store.handleUndoShortcut === 'function') {
                        debug('handleUndoShortcut method exists', 'success');
                    } else {
                        debug('handleUndoShortcut method missing', 'error');
                    }

                    if (typeof store.handleRedoShortcut === 'function') {
                        debug('handleRedoShortcut method exists', 'success');
                    } else {
                        debug('handleRedoShortcut method missing', 'error');
                    }

                    document.getElementById('store-status').innerHTML =
                        '<div class="status success">‚úÖ UndoRedo store loaded successfully</div>';

                }).catch(error => {
                    debug(`Failed to load undo/redo store: ${error.message}`, 'error');
                    document.getElementById('store-status').innerHTML =
                        `<div class="status error">‚ùå Failed to load store: ${error.message}</div>`;
                });

            } catch (error) {
                debug(`Error testing undo/redo store: ${error.message}`, 'error');
                document.getElementById('store-status').innerHTML =
                    `<div class="status error">‚ùå Error: ${error.message}</div>`;
            }
        };

        // Test task operations
        window.testTaskOperations = function() {
            debug('Testing task operations with undo/redo...', 'info');

            try {
                import('/src/stores/tasks.js').then(({ useTaskStore }) => {
                    const taskStore = useTaskStore();

                    debug(`Task Store loaded: ${!!taskStore}`, 'success');

                    // Check if undo-enabled methods exist
                    const undoMethods = [
                        'createTaskWithUndo',
                        'updateTaskWithUndo',
                        'deleteTaskWithUndo',
                        'moveTaskWithUndo'
                    ];

                    undoMethods.forEach(method => {
                        if (typeof taskStore[method] === 'function') {
                            debug(`‚úÖ ${method} method exists`, 'success');
                        } else {
                            debug(`‚ùå ${method} method missing`, 'error');
                        }
                    });

                    document.getElementById('store-status').innerHTML +=
                        '<div class="status success">‚úÖ Task operations test completed</div>';

                }).catch(error => {
                    debug(`Failed to test task operations: ${error.message}`, 'error');
                });

            } catch (error) {
                debug(`Error testing task operations: ${error.message}`, 'error');
            }
        };

        // Test keyboard shortcuts
        window.testKeyboardShortcuts = function() {
            debug('Testing keyboard shortcut handler...', 'info');

            try {
                import('/src/utils/globalKeyboardHandler.js').then(({ initGlobalKeyboardShortcuts }) => {
                    debug('Global keyboard handler imported successfully', 'success');

                    // Test initialization
                    initGlobalKeyboardShortcuts({
                        enabled: true,
                        preventDefault: true,
                        ignoreInputs: true,
                        ignoreModals: true
                    });

                    debug('Global keyboard shortcuts initialized', 'success');
                    debug('Try pressing Ctrl+Z in this window to test', 'info');

                    document.getElementById('store-status').innerHTML +=
                        '<div class="status success">‚úÖ Keyboard shortcuts test completed</div>';

                }).catch(error => {
                    debug(`Failed to test keyboard shortcuts: ${error.message}`, 'error');
                    document.getElementById('store-status').innerHTML +=
                        `<div class="status error">‚ùå Keyboard shortcuts error: ${error.message}</div>`;
                });

            } catch (error) {
                debug(`Error testing keyboard shortcuts: ${error.message}`, 'error');
            }
        };

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            debug('Undo/Redo debug test page loaded', 'info');
            checkSystemStatus();
        });
    </script>
</body>
</html>