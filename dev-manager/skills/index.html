<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skills Graph</title>
    <script src="https://unpkg.com/d3@7"></script>
    <script src="https://unpkg.com/force-graph"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .header {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(148, 163, 184, 0.15);
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex-shrink: 0;
        }

        .title {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #f1f5f9;
        }

        .search-box {
            flex: 1;
            max-width: 300px;
        }

        .search-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 6px;
            color: #e2e8f0;
            font-size: 0.875rem;
        }

        .search-input:focus {
            outline: none;
            border-color: #10b981;
        }

        .search-input::placeholder {
            color: #64748b;
        }

        .stats {
            display: flex;
            gap: 1rem;
            font-size: 0.75rem;
            color: #64748b;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .stat-value {
            color: #94a3b8;
            font-weight: 600;
        }

        .graph-container {
            flex: 1;
            position: relative;
        }

        #graph {
            width: 100%;
            height: 100%;
        }

        .controls {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            display: flex;
            gap: 0.25rem;
            z-index: 100;
        }

        .control-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 6px;
            color: #e2e8f0;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.2s;
        }

        .control-btn:hover {
            background: rgba(30, 41, 59, 0.9);
            border-color: #10b981;
        }

        .detail-panel {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 320px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 8px;
            padding: 1rem;
            display: none;
            z-index: 100;
        }

        .detail-panel.visible {
            display: block;
        }

        .detail-close {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            font-size: 1.25rem;
            line-height: 1;
        }

        .detail-close:hover {
            color: #94a3b8;
        }

        .detail-title {
            font-size: 1rem;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 0.5rem;
            padding-right: 1.5rem;
        }

        .detail-folder {
            font-size: 0.75rem;
            color: #64748b;
            word-break: break-all;
            margin-bottom: 0.75rem;
            font-family: monospace;
        }

        .detail-category {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-bottom: 0.75rem;
        }

        .detail-description {
            font-size: 0.8rem;
            color: #94a3b8;
            line-height: 1.4;
            margin-bottom: 0.75rem;
            max-height: 100px;
            overflow-y: auto;
        }

        .detail-actions {
            display: flex;
            gap: 0.5rem;
        }

        .detail-btn {
            flex: 1;
            padding: 0.5rem;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .detail-btn-primary {
            background: #10b981;
            border: none;
            color: white;
        }

        .detail-btn-primary:hover {
            background: #059669;
        }

        .detail-btn-secondary {
            background: transparent;
            border: 1px solid rgba(148, 163, 184, 0.3);
            color: #94a3b8;
        }

        .detail-btn-secondary:hover {
            background: rgba(148, 163, 184, 0.1);
            border-color: rgba(148, 163, 184, 0.5);
        }

        .legend {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 8px;
            padding: 0.75rem;
            z-index: 100;
            max-height: calc(100% - 2rem);
            overflow-y: auto;
        }

        .legend-title {
            font-size: 0.7rem;
            color: #64748b;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .legend-items {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="title">
                <span>ðŸŽ¯</span>
                <span>Skills</span>
            </div>

            <div class="search-box">
                <input type="text" class="search-input" id="search" placeholder="Search skills...">
            </div>

            <div class="stats">
                <div class="stat">
                    <span>Skills:</span>
                    <span class="stat-value" id="skillCount">0</span>
                </div>
                <div class="stat">
                    <span>Categories:</span>
                    <span class="stat-value" id="categoryCount">0</span>
                </div>
            </div>
        </header>

        <div class="graph-container">
            <div id="graph"></div>

            <div class="controls">
                <button class="control-btn" id="zoomIn" title="Zoom in">+</button>
                <button class="control-btn" id="zoomOut" title="Zoom out">âˆ’</button>
                <button class="control-btn" id="zoomFit" title="Fit to view">âŠ¡</button>
            </div>

            <div class="detail-panel" id="detailPanel">
                <button class="detail-close" id="detailClose">Ã—</button>
                <div class="detail-title" id="detailTitle"></div>
                <div class="detail-folder" id="detailFolder"></div>
                <div class="detail-category" id="detailCategory"></div>
                <div class="detail-description" id="detailDescription"></div>
                <div class="detail-actions">
                    <button class="detail-btn detail-btn-primary" id="openSkill">Open SKILL.md</button>
                    <button class="detail-btn detail-btn-secondary" id="copyPath">Copy Path</button>
                </div>
            </div>

            <div class="legend">
                <div class="legend-title">Categories</div>
                <div class="legend-items" id="legendItems"></div>
            </div>
        </div>
    </div>

    <script>
        // Category colors
        const COLORS = {
            'debugging': '#ef4444',
            'development': '#10b981',
            'architecture': '#3b82f6',
            'operations': '#f59e0b',
            'documentation': '#8b5cf6',
            'testing': '#06b6d4',
            'data': '#ec4899',
            'other': '#94a3b8'
        };

        let graphData = null;
        let graph = null;
        let selectedNode = null;

        // Load data and initialize
        async function init() {
            try {
                const response = await fetch('/skills/graph-data.json?v=' + Date.now());
                graphData = await response.json();

                updateStats();
                buildLegend();
                initGraph();
            } catch (error) {
                console.error('Failed to load graph data:', error);
                document.getElementById('graph').innerHTML =
                    '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#64748b;">' +
                    'Failed to load graph data. Run: npm run skills:graph</div>';
            }
        }

        function updateStats() {
            document.getElementById('skillCount').textContent = graphData.stats.totalSkills;
            document.getElementById('categoryCount').textContent = graphData.stats.categories.length;
        }

        // Category emojis for legend
        const LEGEND_EMOJIS = {
            'debugging': 'ðŸ›',
            'development': 'ðŸ’»',
            'architecture': 'ðŸ—ï¸',
            'operations': 'âš™ï¸',
            'documentation': 'ðŸ“š',
            'testing': 'ðŸ§ª',
            'data': 'ðŸ’¾',
            'other': 'ðŸ”§'
        };

        function buildLegend() {
            const categories = graphData.stats.categories;
            const legendItems = document.getElementById('legendItems');
            legendItems.innerHTML = '';

            categories.forEach(cat => {
                const emoji = LEGEND_EMOJIS[cat] || 'ðŸ”§';
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `
                    <div class="legend-dot" style="background: ${COLORS[cat] || COLORS.other}"></div>
                    <span>${emoji} ${cat.charAt(0).toUpperCase() + cat.slice(1)}</span>
                `;
                legendItems.appendChild(item);
            });
        }

        // Category emojis
        const CATEGORY_EMOJIS = {
            'debugging': 'ðŸ›',
            'development': 'ðŸ’»',
            'architecture': 'ðŸ—ï¸',
            'operations': 'âš™ï¸',
            'documentation': 'ðŸ“š',
            'testing': 'ðŸ§ª',
            'data': 'ðŸ’¾',
            'other': 'ðŸ”§'
        };

        function getNodeSize(node) {
            if (node.isCategory) return 22;
            // Use usage from graph data, default to 1
            const usage = node.usage || 1;
            // Scale from 10 (unused) to 28 (heavily used)
            // Log scale to make differences more visible
            const logUsage = Math.log10(usage + 1);
            const maxLog = Math.log10(100); // Assume max 100 calls
            return 10 + (logUsage / maxLog) * 18;
        }

        function initGraph() {
            const container = document.getElementById('graph');

            graph = ForceGraph()(container)
                .graphData(graphData)
                .backgroundColor('#0f172a')
                .nodeColor(node => node.color || COLORS.other)
                .nodeVal(node => node.isCategory ? 25 : 8)
                .nodeLabel(node => node.title)
                .linkColor(() => 'rgba(148, 163, 184, 0.25)')
                .linkWidth(2)
                .onNodeClick(handleNodeClick)
                .onNodeHover(handleNodeHover)
                .cooldownTicks(200)
                .warmupTicks(100)
                .onEngineStop(() => graph.zoomToFit(400, 60));

            // EXTREME repulsion - ensure no overlaps at all
            graph.d3Force('charge', d3.forceManyBody().strength(-800).distanceMax(1200));
            graph.d3Force('link').distance(200).strength(0.15);
            // Center force to keep graph centered
            graph.d3Force('center', d3.forceCenter());
            // Massive collision radius - labels can be 80px wide + node size
            graph.d3Force('collide', d3.forceCollide().radius(node => getNodeSize(node) + 100).strength(1).iterations(10));
            // Spread nodes outward significantly
            graph.d3Force('radial', d3.forceRadial(600, 0, 0).strength(node => node.isCategory ? 0 : 0.2));

            // Custom node rendering with emojis inside circles
            graph.nodeCanvasObject((node, ctx, globalScale) => {
                const emoji = CATEGORY_EMOJIS[node.category] || 'ðŸ”§';
                const nodeSize = getNodeSize(node);
                const emojiSize = node.isCategory ? 18 / globalScale : 14 / globalScale;

                // Draw node circle with slight transparency
                ctx.beginPath();
                ctx.arc(node.x, node.y, nodeSize, 0, 2 * Math.PI);
                ctx.fillStyle = (node.color || COLORS.other) + 'cc'; // Add transparency
                ctx.fill();

                // Draw border
                ctx.strokeStyle = node.color || COLORS.other;
                ctx.lineWidth = 2 / globalScale;
                ctx.stroke();

                // Highlight selected node
                if (selectedNode && selectedNode.id === node.id) {
                    ctx.strokeStyle = '#22c55e';
                    ctx.lineWidth = 3 / globalScale;
                    ctx.stroke();
                }

                // Draw emoji inside the circle
                ctx.font = `${emojiSize}px Sans-Serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(emoji, node.x, node.y);

                // Draw label below node - ALWAYS show labels, larger font
                const minLabelSize = 11; // Minimum label size in pixels
                const labelFontSize = Math.max(minLabelSize, node.isCategory ? 14 / globalScale : 12 / globalScale);
                ctx.font = `${node.isCategory ? 'bold ' : ''}${labelFontSize}px Sans-Serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'top';
                ctx.fillStyle = node.isCategory ? '#f1f5f9' : '#e2e8f0';

                // Truncate label for non-category nodes - shorter to prevent overlaps
                let label = node.title;
                if (!node.isCategory && label.length > 18) {
                    label = label.substring(0, 15) + '...';
                }
                ctx.fillText(label, node.x, node.y + nodeSize + 4);
            });
        }

        function handleNodeClick(node) {
            if (!node || node.isCategory) return;

            selectedNode = node;
            showDetailPanel(node);
            graph.nodeColor(graph.nodeColor()); // Trigger re-render
        }

        function handleNodeHover(node) {
            document.body.style.cursor = node && !node.isCategory ? 'pointer' : 'default';
        }

        function showDetailPanel(node) {
            const panel = document.getElementById('detailPanel');
            const title = document.getElementById('detailTitle');
            const folder = document.getElementById('detailFolder');
            const category = document.getElementById('detailCategory');
            const description = document.getElementById('detailDescription');

            title.textContent = node.title;
            folder.textContent = '.claude/skills/' + node.name;
            category.textContent = node.category;
            category.style.background = node.color + '33';
            category.style.color = node.color;
            description.textContent = node.description || 'No description available';

            panel.classList.add('visible');
        }

        function hideDetailPanel() {
            document.getElementById('detailPanel').classList.remove('visible');
            selectedNode = null;
            if (graph) graph.nodeColor(graph.nodeColor());
        }

        // Event listeners
        document.getElementById('search').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            if (!graph) return;

            graph.nodeColor(node => {
                if (term && (node.title?.toLowerCase().includes(term) || node.name?.toLowerCase().includes(term))) {
                    return '#22c55e'; // highlight green
                }
                return node.color || COLORS.other;
            });
        });

        document.getElementById('zoomIn').addEventListener('click', () => {
            graph.zoom(graph.zoom() * 1.5, 300);
        });

        document.getElementById('zoomOut').addEventListener('click', () => {
            graph.zoom(graph.zoom() / 1.5, 300);
        });

        document.getElementById('zoomFit').addEventListener('click', () => {
            graph.zoomToFit(400, 50);
        });

        document.getElementById('detailClose').addEventListener('click', hideDetailPanel);

        document.getElementById('openSkill').addEventListener('click', () => {
            if (selectedNode) {
                const skillPath = '/.claude/skills/' + selectedNode.name + '/SKILL.md';
                window.open(skillPath, '_blank');
            }
        });

        document.getElementById('copyPath').addEventListener('click', () => {
            if (selectedNode) {
                const fullPath = '.claude/skills/' + selectedNode.name;
                navigator.clipboard.writeText(fullPath).then(() => {
                    const btn = document.getElementById('copyPath');
                    btn.textContent = 'Copied!';
                    setTimeout(() => btn.textContent = 'Copy Path', 1500);
                });
            }
        });

        // Initialize
        init();
    </script>
</body>
</html>
