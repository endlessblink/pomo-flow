<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keyboard Debug Panel</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .status-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        .status-good { border-left: 4px solid #28a745; }
        .status-warning { border-left: 4px solid #ffc107; }
        .status-error { border-left: 4px solid #dc3545; }
        .log-container {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: #007bff;
            color: white;
        }
        button:hover { background: #0056b3; }
        button.secondary { background: #6c757d; }
        button.secondary:hover { background: #545b62; }
        iframe {
            width: 100%;
            height: 500px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .instructions {
            background: #d1ecf1;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #0c5460;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>üîç Pomo-Flow Keyboard Debug Panel</h1>

    <div class="instructions">
        <h3>üéØ Purpose:</h3>
        <p>This debug panel helps identify keyboard shortcut issues by showing real-time event flow and handler status.</p>
        <ul>
            <li>Check console filter status below</li>
            <li>Test keyboard shortcuts manually</li>
            <li>Monitor event logs in real-time</li>
            <li>Identify handler conflicts</li>
        </ul>
    </div>

    <div class="debug-panel">
        <h2>üìä System Status</h2>
        <div class="status-grid" id="statusGrid">
            <!-- Status items will be populated by JavaScript -->
        </div>

        <div class="controls">
            <button onclick="checkSystemStatus()">üîÑ Refresh Status</button>
            <button onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
            <button onclick="testKeyboardEvent()" class="secondary">üß™ Test Event</button>
            <button onclick="toggleConsoleFilter()" class="secondary">üîß Toggle Console Filter</button>
        </div>

        <h3>üìù Real-time Event Log</h3>
        <div class="log-container" id="logContainer">
            <div>Waiting for keyboard events...</div>
        </div>
    </div>

    <div class="debug-panel">
        <h2>üåê Application Test</h2>
        <iframe id="appFrame" src="http://localhost:5546" title="Pomo-Flow Application"></iframe>
    </div>

    <script>
        const logContainer = document.getElementById('logContainer');
        const statusGrid = document.getElementById('statusGrid');
        const appFrame = document.getElementById('appFrame');

        let eventCount = 0;
        const maxLogEntries = 50;

        // Add log entry
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.innerHTML = `<span style="color: #81c784">[${timestamp}]</span> ${message}`;

            logContainer.appendChild(entry);
            eventCount++;

            // Keep only last N entries
            if (logContainer.children.length > maxLogEntries) {
                logContainer.removeChild(logContainer.firstChild);
            }

            // Auto-scroll to bottom
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Check system status
        function checkSystemStatus() {
            const statusItems = [];

            // Check console filter
            if (appFrame.contentWindow && appFrame.contentWindow.consoleFilter) {
                const toggles = appFrame.contentWindow.consoleFilter.getToggles();
                statusItems.push({
                    title: 'Console Filter',
                    status: toggles.keyboardShortcuts ? 'good' : 'warning',
                    details: `Keyboard shortcuts: ${toggles.keyboardShortcuts ? '‚úÖ Enabled' : '‚ùå Disabled'}`
                });
            } else {
                statusItems.push({
                    title: 'Console Filter',
                    status: 'error',
                    details: '‚ùå Not available (iframe restriction or not loaded)'
                });
            }

            // Check application URL
            statusItems.push({
                title: 'Application URL',
                status: 'good',
                details: `üìç ${appFrame.src}`
            });

            // Check event count
            statusItems.push({
                title: 'Events Detected',
                status: eventCount > 0 ? 'good' : 'warning',
                details: `üî¢ ${eventCount} keyboard events logged`
            });

            // Render status
            statusGrid.innerHTML = statusItems.map(item => `
                <div class="status-item status-${item.status}">
                    <h4>${item.title}</h4>
                    <p>${item.details}</p>
                </div>
            `).join('');
        }

        // Clear logs
        function clearLogs() {
            logContainer.innerHTML = '<div>Logs cleared...</div>';
            eventCount = 0;
            checkSystemStatus();
        }

        // Test keyboard event
        function testKeyboardEvent() {
            addLog('üß™ Testing manual keyboard event dispatch...');

            if (appFrame.contentWindow) {
                const testEvent = new KeyboardEvent('keydown', {
                    key: '1',
                    shiftKey: true,
                    ctrlKey: false,
                    metaKey: false,
                    altKey: false,
                    bubbles: true,
                    cancelable: true
                });

                appFrame.contentWindow.dispatchEvent(testEvent);
                addLog('üì§ Dispatched Shift+1 event to iframe');
            } else {
                addLog('‚ùå Cannot access iframe content (cross-origin restriction)');
            }
        }

        // Toggle console filter (if available)
        function toggleConsoleFilter() {
            if (appFrame.contentWindow && appFrame.contentWindow.consoleFilter) {
                const toggles = appFrame.contentWindow.consoleFilter.getToggles();
                const newState = !toggles.keyboardShortcuts;

                appFrame.contentWindow.consoleFilter.saveToggles({
                    ...toggles,
                    keyboardShortcuts: newState
                });

                addLog(`üîß Keyboard logging ${newState ? 'enabled' : 'disabled'}`);
                checkSystemStatus();
            } else {
                addLog('‚ùå Console filter not available');
            }
        }

        // Listen for keyboard events on this page
        document.addEventListener('keydown', function(event) {
            const { shiftKey, ctrlKey, metaKey, altKey, key } = event;

            // Only log Shift+1-5 to avoid spam
            if (shiftKey && !ctrlKey && !metaKey && !altKey && key >= '1' && key <= '5') {
                addLog(`‚å®Ô∏è Shift+${key} detected on debug page`);

                // Forward to iframe
                if (appFrame.contentWindow) {
                    const iframeEvent = new KeyboardEvent('keydown', {
                        key: key,
                        shiftKey: shiftKey,
                        ctrlKey: ctrlKey,
                        metaKey: metaKey,
                        altKey: altKey,
                        bubbles: true,
                        cancelable: true
                    });

                    appFrame.contentWindow.dispatchEvent(iframeEvent);
                    addLog(`üì§ Forwarded Shift+${key} to application iframe`);
                }
            }
        });

        // Monitor iframe load
        appFrame.addEventListener('load', function() {
            addLog('‚úÖ Application iframe loaded');
            setTimeout(checkSystemStatus, 1000); // Wait a bit for app to initialize
        });

        // Initialize
        addLog('üöÄ Keyboard debug panel initialized');
        addLog('üìã Press Shift+1-5 to test keyboard shortcuts');
        checkSystemStatus();

        // Check status periodically
        setInterval(checkSystemStatus, 5000);
    </script>
</body>
</html>